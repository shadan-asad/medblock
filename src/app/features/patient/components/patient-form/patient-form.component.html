<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h3 class="card-title mb-4">{{ isEditMode ? 'Edit Patient' : 'Register New Patient' }}</h3>

      <!-- Loading Spinner -->
      <app-loading-spinner *ngIf="loading" 
                           [message]="isEditMode ? 'Saving patient details...' : 'Registering patient...'"
                           [overlay]="true">
      </app-loading-spinner>

      <!-- Error Message -->
      <div *ngIf="errorMsg" class="alert alert-danger" role="alert">
        {{ errorMsg }}
      </div>

      <!-- Success Message -->
      <div *ngIf="successMsg" class="alert alert-success" role="alert">
        {{ successMsg }}
      </div>

      <!-- Patient Form -->
      <form [formGroup]="patientForm" (ngSubmit)="onSubmit()" *ngIf="!loading">
        <div class="row">
          <!-- First Name -->
          <div class="col-md-6 mb-3">
            <label for="firstName" class="form-label">First Name</label>
            <input type="text" class="form-control" id="firstName" formControlName="firstName"
                   [ngClass]="{'is-invalid': patientForm.get('firstName')?.invalid && patientForm.get('firstName')?.touched}">
            <div class="invalid-feedback" *ngIf="patientForm.get('firstName')?.errors?.['required'] && patientForm.get('firstName')?.touched">
              First name is required
            </div>
            <div class="invalid-feedback" *ngIf="patientForm.get('firstName')?.errors?.['minlength'] && patientForm.get('firstName')?.touched">
              First name must be at least 2 characters
            </div>
          </div>

          <!-- Last Name -->
          <div class="col-md-6 mb-3">
            <label for="lastName" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="lastName" formControlName="lastName"
                   [ngClass]="{'is-invalid': patientForm.get('lastName')?.invalid && patientForm.get('lastName')?.touched}">
            <div class="invalid-feedback" *ngIf="patientForm.get('lastName')?.errors?.['required'] && patientForm.get('lastName')?.touched">
              Last name is required
            </div>
            <div class="invalid-feedback" *ngIf="patientForm.get('lastName')?.errors?.['minlength'] && patientForm.get('lastName')?.touched">
              Last name must be at least 2 characters
            </div>
          </div>

          <!-- Date of Birth -->
          <div class="col-md-6 mb-3">
            <label for="dateOfBirth" class="form-label">Date of Birth</label>
            <input type="date" class="form-control" id="dateOfBirth" formControlName="dateOfBirth"
                   [ngClass]="{'is-invalid': patientForm.get('dateOfBirth')?.invalid && patientForm.get('dateOfBirth')?.touched}">
            <div class="invalid-feedback" *ngIf="patientForm.get('dateOfBirth')?.errors?.['required'] && patientForm.get('dateOfBirth')?.touched">
              Date of birth is required
            </div>
          </div>

          <!-- Email -->
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" formControlName="email"
                   [ngClass]="{'is-invalid': patientForm.get('email')?.invalid && patientForm.get('email')?.touched}">
            <div class="invalid-feedback" *ngIf="patientForm.get('email')?.errors?.['required'] && patientForm.get('email')?.touched">
              Email is required
            </div>
            <div class="invalid-feedback" *ngIf="patientForm.get('email')?.errors?.['email'] && patientForm.get('email')?.touched">
              Please enter a valid email address
            </div>
          </div>

          <!-- Phone -->
          <div class="col-md-6 mb-3">
            <label for="phone" class="form-label">Phone</label>
            <input type="tel" class="form-control" id="phone" formControlName="phone"
                   [ngClass]="{'is-invalid': patientForm.get('phone')?.invalid && patientForm.get('phone')?.touched}">
            <div class="invalid-feedback" *ngIf="patientForm.get('phone')?.errors?.['required'] && patientForm.get('phone')?.touched">
              Phone number is required
            </div>
            <div class="invalid-feedback" *ngIf="patientForm.get('phone')?.errors?.['pattern'] && patientForm.get('phone')?.touched">
              Please enter a valid 10-digit phone number
            </div>
          </div>

          <!-- Address -->
          <div class="col-md-6 mb-3">
            <label for="address" class="form-label">Address</label>
            <input type="text" class="form-control" id="address" formControlName="address"
                   [ngClass]="{'is-invalid': patientForm.get('address')?.invalid && patientForm.get('address')?.touched}">
            <div class="invalid-feedback" *ngIf="patientForm.get('address')?.errors?.['required'] && patientForm.get('address')?.touched">
              Address is required
            </div>
          </div>

          <!-- Medical History -->
          <div class="col-12 mb-3">
            <label for="medicalHistory" class="form-label">Medical History</label>
            <textarea class="form-control" id="medicalHistory" rows="4" formControlName="medicalHistory"></textarea>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button type="button" class="btn btn-outline-secondary" routerLink="/patients">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" 
                  [disabled]="patientForm.invalid || loading || (isEditMode && !formChanged)">
            {{ isEditMode ? 'Update Patient' : 'Register Patient' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
